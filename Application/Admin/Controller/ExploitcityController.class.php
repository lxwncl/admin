<?php
/**
 * Created by PhpStorm.
 * User: lxwn
 * Date: 2018/5/21
 * Time: 上午10:06
 */

namespace  Admin\Controller;

class ExploitcityController extends AdminBaseController
{
	public function _initialize()
	{
		parent::_initialize(); // TODO: Change the autogenerated stub
	}

	public function index()
	{
		$p_info         =   M('areas')->where("area_tag=1")->select();
		$c_info         =   M('areas')->where("area_tag=2")->select();
		$list           =   D('XcxExploitCity')->getExploitCityList();

		$this->assign('json_city',json_encode($c_info));
		$this->assign('p_info',$p_info);
		$this->assign('list',$list);
		$this->display();
	}

	public function ajaxAddCity()
	{
		$data                   =   I('post.');
		$field_arr              =   array('p_id','c_id');

		if (checkFieldBeEmpty($data,$field_arr)) {
			$this->output(99999);
		}

		$c_info                 =   M('xcx_exploit_city')->where("c_id={$data['c_id']}")->find();

		if ($c_info) {
			$this->output(80001);
		}
		$data['create_time']    =   date('Y-m-d H:i:s');
		$result                 =   M('xcx_exploit_city')->add($data);

		$result                 ?   $this->output(1)    :   $this->output(40000);
	}

	public function ajaxDel()
	{
		$id                     =   I('get.id');

		if (empty($id)) {
			$this->output(99999);
		}

		$where                  =   "id={$id}";
		$exploit_city_info      =   M('xcx_exploit_city')->where($where)->find();

		if (empty($exploit_city_info)) {
			$this->output(70002);
		}

		$user_info              =   M('admin_user')->where("c_id={$exploit_city_info['c_id']}")->select();

		if ($user_info) {
			$msg                =   "";
			foreach($user_info as $k=>$v){
				$msg            .=  ",".$v['account'];
			}
			$msg                =   trim($msg,',');
			$msg                .=  "账号正在使用该城市，请修改用户所在城市再删除";
			$this->output($msg);
		}

		$result                 =   M('xcx_exploit_city')->where($where)->delete();

		$result                 ?   $this->output(1)    :   $this->output(40000);
	}
}