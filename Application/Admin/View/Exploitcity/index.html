<fieldset class="layui-elem-field" style="margin: 10px;">
    <legend>开通城市</legend>
    <div class="layui-row">
        <div style="margin:10px;">
            <form class="layui-form">
                <div class="layui-inline">
                    <select name="p_id" lay-verify="required" id="p_id" lay-filter="p_id" >
                        <option value="">请选择一个省份</option>
                        <volist name="p_info" id="vo">
                            <option value="{$vo[area_id]}">{$vo['area_name']}</option>
                        </volist>
                    </select>
                </div>
                <div  class="layui-inline">
                    <select name="c_id" lay-verify="required" id="c_id" lay-filter="c_id">
                    </select>
                </div>
                <div  class="layui-inline">
                    <button type="button" class="layui-btn" lay-submit="">添加</button>
                </div>
            </form>
        </div>
    </div>

    <div class="site-text site-block">
        <div class="layui-form" style="margin:20px;">
            <table class="layui-table">
                <thead>
                <tr>
                    <th  style="width:2%">id</th>
                    <th class="value_col" >省</th>
                    <th class="value_col" >市</th>
                    <th class="value_col" >开通时间</th>
                    <th class="value_col" >操作</th>
                </tr>
                </thead>
                <tbody>
                <volist name="list" id="vo">
                    <tr class="">
                        <td>{$vo[id]}</td>
                        <td class="value_col">
                            <div class="layui-table-cell laytable-cell-1-username">{$vo['p_name']}</div>
                        </td>
                        <td class="value_col">
                            <div class="layui-table-cell laytable-cell-1-username">{$vo['c_name']}</div>
                        </td>
                        <td class="value_col">
                            <div class="layui-table-cell laytable-cell-1-username">{$vo['create_time']}</div>
                        </td>
                        <td class="value_col">
                            <button class="layui-btn layui-btn-danger layui-btn-fluid" onclick="del({$vo['id']})">删除</button>
                        </td>
                    </tr>
                </volist>
            </table>
        </div>
    </div>
</fieldset>

<script>
    var city        =   {$json_city}
</script>
<script>
    layui.use(['layer','form'],function(){
        var form = layui.form;
        form.on('select(p_id)',function(data){
            setCityHtml(data.value);
            form.render('select');
        });
        form.on('submit()',function(data){
            ajaxSubmit(data.field);
        });

    });

    function ajaxSubmit(data)
    {
        $.ajax({
            url:"{:U('ajaxAddCity')}",
            type:"POST",
            data:data,
            success:function(res){
                if (res.code == 1) {
                    window.location.href = "{:U('index')}";
                }else{
                    layer.msg(res.msg);
                }
            }
        });
    }

    function del(id)
    {
        layer.confirm('是否确认删除', {
            btn: ['是','否'] //按钮
        }, function(){
            ajaxDel(id);
        });
    }

    function ajaxDel(id)
    {
        $.ajax({
            url:"{:U('ajaxDel')}",
            data:{id:id},
            success:function(res){
                if (res.code == 1) {
                    window.location.href = "{:U('index')}";
                } else {
                    layer.msg(res.msg);
                }
            }
        })
    }

    function setCityHtml(p_id)
    {

        var html    =   "<option value=''>请选择一个城市</option>";
        for(var i in city){
            if (city[i]['parent_id'] == p_id) {
                html+=  "<option value='"+city[i]['area_id']+"'>"+city[i]['area_name']+"</option>";
            }
        }
        $('#c_id').html(html);
    }
</script>
